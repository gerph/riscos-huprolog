struct { int dummy ; } __extradata;

#include   <stdio.h>
#include   <stdlib.h>
#include   <string.h>
#include   <kernel.h>

#define NHANDLES (32)
#define MINHANDLE (3)

static char *opentab[] = { "r", "w" "r+" };
static int  unixio_raw = 1;
static FILE *handles[NHANDLES];

#define SETUP if( unixio_raw ) setup_unixio()
#define CHECK(strmno) \
    do { \
       if (strmno < 0 || strmno >= NHANDLES || \
           handles[strmno] == NULL) \
         return -1; \
       hndle = handles[strmno]; \
    } while (0)

static void setup_unixio(void)
{
int i;
    for( i = 0; i < NHANDLES; ++i )
       handles[i] = NULL;
    handles[0] = stdin;
    handles[1] = stdout;
    handles[2] = stderr;
    unixio_raw = 0;
}


int open(char *name, int mode)
{
FILE  *hndle;
      SETUP;
      if( mode < 0 || mode > 2 )
          return -1;
      hndle = fopen( name, opentab[mode] );
      if( hndle == NULL )
          return -1;
      {
        /* Find a handle */
        int handle;
        for (handle= MINHANDLE;
             handle<NHANDLES;
             handle++)
        {
            if (handles[handle] == NULL)
                break;
        }
        if (handle == NHANDLES)
        {
            fclose(hndle);
            return -1; /* No free handles */
        }
        setvbuf( hndle, NULL, _IONBF, (size_t)0 );
        return handle;
      }
}

int creat(char *name, int access)
{

FILE  *hndle;
      SETUP;
      hndle = fopen( name, "w+" );
      if( hndle == NULL )
          return -1;

      {
        /* Find a handle */
        int handle;
        for (handle= MINHANDLE;
             handle<NHANDLES;
             handle++)
        {
            if (handles[handle] == NULL)
                break;
        }
        if (handle == NHANDLES)
        {
            fclose(hndle);
            return -1; /* No free handles */
        }
        setvbuf( hndle, NULL, _IONBF, (size_t)0 );
        return handle;
      }
}


int close(int strmno)
{
       SETUP;
       if (strmno < 0 || strmno >= NHANDLES ||
           handles[strmno] == NULL)
         return -1;
       fclose( handles[strmno] );
       handles[strmno] = NULL;
       return 0;
}

int unlink(char *name)
{
       return remove( name );
}

int hu_isatty(int strmno)
{
       SETUP;
       switch (strmno)
       {
        case 0:
        case 1:
        case 2:
            return 1;
       }
       return 0;
}

int write(int strmno, char *buf, int len)
{
FILE  *hndle;
int   written;
      SETUP;
      CHECK(strmno);
      written = (int) fwrite( buf, (size_t) 1, (size_t) len, hndle );
      if( fflush(hndle) )
          return -1;
      return written;
}



int read(int strmno, char *buf, int len)
{
FILE  *hndle;
int   readden;

      SETUP;
      CHECK(strmno);
      if( hndle == stdin ) {
        if( fgets( buf, len, stdin ) == NULL )
          readden = 0;
        else
          readden = strlen( buf );
      } else {
        readden = (int) fread( buf, (size_t) 1, (size_t) len, hndle );
      }

      if( ferror( hndle ) )
          return -1;
      else
          return readden;

}

int fseektab[]={ SEEK_SET, SEEK_CUR, SEEK_END };

int lseek(int strmno, long position, int whence)
{
FILE *hndle;
     SETUP;
     CHECK(strmno);
     return fseek( hndle, position, fseektab[whence] );
}

void prt(char *s)
{
     fputs( s, stderr );
}


